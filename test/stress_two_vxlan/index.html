
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Open vSwitch学习笔记">
      
      
        <link rel="canonical" href="https://cyent.github.io/ovs/test/stress_two_vxlan/">
      
      
        <meta name="author" content="cyent">
      
      
        <link rel="shortcut icon" href="../../assets/images/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.3, mkdocs-material-1.10.1">
    
    
      
        <title>2.4. 不同宿主(vxlan封装) - ovs学习 - cyent笔记</title>
      
    
    
      <script src="../../assets/javascripts/modernizr-e826f8942a.js"></script>
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application-a20f419c8e.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-23f75ab9c7.palette.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
  
  
  
    <body data-md-color-primary="blue-grey" data-md-color-accent="pink">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://cyent.github.io/ovs/" title="ovs学习 - cyent笔记" class="md-header-nav__button md-logo">
          
            <i class="md-icon md-icon--home"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  五. 实验
                </span>
              
                <span class="md-header-nav__parent">
                  2. 性能测试
                </span>
              
            
            2.4. 不同宿主(vxlan封装)
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result" data-md-lang-search="" data-md-lang-tokenizer="[\s\-]+">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/cyent/ovs" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      cyent/ovs
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <div class="md-nav__button md-logo">
      
        <i class="md-icon md-icon--home"></i>
      
    </div>
    ovs学习 - cyent笔记
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/cyent/ovs" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      cyent/ovs
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="一. 介绍" class="md-nav__link">
      一. 介绍
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../install/" title="二. 安装" class="md-nav__link">
      二. 安装
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../ovs/" title="三. ovs" class="md-nav__link">
      三. ovs
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../openflow/" title="四. openflow" class="md-nav__link">
      四. openflow
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      五. 实验
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        五. 实验
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../test1/" title="1. 实验1" class="md-nav__link">
      1. 实验1
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2" type="checkbox" id="nav-5-2" checked>
    
    <label class="md-nav__link" for="nav-5-2">
      2. 性能测试
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-2">
        2. 性能测试
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../stress_main/" title="2.1. 环境说明" class="md-nav__link">
      2.1. 环境说明
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../stress_one/" title="2.2. 同宿主" class="md-nav__link">
      2.2. 同宿主
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../stress_two_novxlan/" title="2.3. 不同宿主(无封装)" class="md-nav__link">
      2.3. 不同宿主(无封装)
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        2.4. 不同宿主(vxlan封装)
      </label>
    
    <a href="./" title="2.4. 不同宿主(vxlan封装)" class="md-nav__link md-nav__link--active">
      2.4. 不同宿主(vxlan封装)
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#bridge" title="bridge" class="md-nav__link">
    bridge
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ns-nsveth" title="ns - ns（veth）" class="md-nav__link">
    ns - ns（veth）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kvm-kvm" title="kvm - kvm" class="md-nav__link">
    kvm - kvm
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ovs" title="ovs" class="md-nav__link">
    ovs
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#keyvni" title="key指定vni" class="md-nav__link">
    key指定vni
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ns-nsveth_1" title="ns - ns（veth）" class="md-nav__link">
    ns - ns（veth）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ns-nsovs-port" title="ns - ns（ovs-port）" class="md-nav__link">
    ns - ns（ovs-port）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kvm-kvm_1" title="kvm - kvm" class="md-nav__link">
    kvm - kvm
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#keyflow" title="key为flow" class="md-nav__link">
    key为flow
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ns-nsveth_2" title="ns - ns（veth）" class="md-nav__link">
    ns - ns（veth）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ns-nsovs-port_1" title="ns - ns（ovs-port）" class="md-nav__link">
    ns - ns（ovs-port）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kvm-kvm_2" title="kvm - kvm" class="md-nav__link">
    kvm - kvm
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ovs-bridge" title="ovs-bridge" class="md-nav__link">
    ovs-bridge
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#keyvni_1" title="key指定vni" class="md-nav__link">
    key指定vni
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ns-nsveth_3" title="ns - ns（veth）" class="md-nav__link">
    ns - ns（veth）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ns-nsovs-port_2" title="ns - ns（ovs-port）" class="md-nav__link">
    ns - ns（ovs-port）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kvm-kvm_3" title="kvm - kvm" class="md-nav__link">
    kvm - kvm
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#keyflow_1" title="key为flow" class="md-nav__link">
    key为flow
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ns-nsveth_4" title="ns - ns（veth）" class="md-nav__link">
    ns - ns（veth）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ns-nsovs-port_3" title="ns - ns（ovs-port）" class="md-nav__link">
    ns - ns（ovs-port）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kvm-kvm_4" title="kvm - kvm" class="md-nav__link">
    kvm - kvm
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#neutron" title="Neutron模式" class="md-nav__link">
    Neutron模式
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kvm-kvm_5" title="kvm - kvm" class="md-nav__link">
    kvm - kvm
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../stress_summary/" title="2.5. 结论" class="md-nav__link">
      2.5. 结论
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      六. 附录
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        六. 附录
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../appendix/doc/" title="1. 参考资料" class="md-nav__link">
      1. 参考资料
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../appendix/traffic/" title="2. ovs数据流量及限速" class="md-nav__link">
      2. ovs数据流量及限速
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../appendix/nxm/" title="3. NXM" class="md-nav__link">
      3. NXM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../appendix/neutron/" title="4. Neutron流表分析" class="md-nav__link">
      4. Neutron流表分析
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../appendix/mac_mask/" title="5. MAC地址掩码" class="md-nav__link">
      5. MAC地址掩码
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../appendix/conntrack/" title="6. ovs模块会调用conntrack" class="md-nav__link">
      6. ovs模块会调用conntrack
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../contact/" title="七. 联系方式" class="md-nav__link">
      七. 联系方式
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#bridge" title="bridge" class="md-nav__link">
    bridge
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ns-nsveth" title="ns - ns（veth）" class="md-nav__link">
    ns - ns（veth）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kvm-kvm" title="kvm - kvm" class="md-nav__link">
    kvm - kvm
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ovs" title="ovs" class="md-nav__link">
    ovs
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#keyvni" title="key指定vni" class="md-nav__link">
    key指定vni
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ns-nsveth_1" title="ns - ns（veth）" class="md-nav__link">
    ns - ns（veth）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ns-nsovs-port" title="ns - ns（ovs-port）" class="md-nav__link">
    ns - ns（ovs-port）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kvm-kvm_1" title="kvm - kvm" class="md-nav__link">
    kvm - kvm
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#keyflow" title="key为flow" class="md-nav__link">
    key为flow
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ns-nsveth_2" title="ns - ns（veth）" class="md-nav__link">
    ns - ns（veth）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ns-nsovs-port_1" title="ns - ns（ovs-port）" class="md-nav__link">
    ns - ns（ovs-port）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kvm-kvm_2" title="kvm - kvm" class="md-nav__link">
    kvm - kvm
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ovs-bridge" title="ovs-bridge" class="md-nav__link">
    ovs-bridge
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#keyvni_1" title="key指定vni" class="md-nav__link">
    key指定vni
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ns-nsveth_3" title="ns - ns（veth）" class="md-nav__link">
    ns - ns（veth）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ns-nsovs-port_2" title="ns - ns（ovs-port）" class="md-nav__link">
    ns - ns（ovs-port）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kvm-kvm_3" title="kvm - kvm" class="md-nav__link">
    kvm - kvm
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#keyflow_1" title="key为flow" class="md-nav__link">
    key为flow
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ns-nsveth_4" title="ns - ns（veth）" class="md-nav__link">
    ns - ns（veth）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ns-nsovs-port_3" title="ns - ns（ovs-port）" class="md-nav__link">
    ns - ns（ovs-port）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kvm-kvm_4" title="kvm - kvm" class="md-nav__link">
    kvm - kvm
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#neutron" title="Neutron模式" class="md-nav__link">
    Neutron模式
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kvm-kvm_5" title="kvm - kvm" class="md-nav__link">
    kvm - kvm
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>2.4. 不同宿主(vxlan封装)</h1>
                
                <h2 id="bridge"><strong>bridge</strong><a class="headerlink" href="#bridge" title="Permanent link">&para;</a></h2>
<hr />
<h3 id="ns-nsveth">ns - ns（veth）<a class="headerlink" href="#ns-nsveth" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span>tcp: 4.45Gb/s
udp:
    client 5.36Gb/s
    server 5.36Gb/s
</pre></div>

<details class="note"><summary>环境</summary><div class="codehilite"><pre><span></span>Host1:
ip link set em1 mtu 1550
brctl addbr br1
ip link set br1 up
ip link add vtep-100 mtu 1500 type vxlan id 100 group 239.0.0.100 ttl 64 dev em1 dstport 4789
ip link set vtep-100 up
brctl addif br1 vtep-100
ip netns add ns1
ip link add ns1-veth-in type veth peer name ns1-veth-out
ip link set ns1-veth-in netns ns1
ip link set ns1-veth-out up
ip netns exec ns1 ip link set lo up
ip netns exec ns1 ifconfig ns1-veth-in 192.168.1.1 netmask 255.255.255.0 up
brctl addif br1 ns1-veth-out

Host2:
ip link set em1 mtu 1550
brctl addbr br1
ip link set br1 up
ip link add vtep-100 mtu 1500 type vxlan id 100 group 239.0.0.100 ttl 64 dev em1 dstport 4789
ip link set vtep-100 up
brctl addif br1 vtep-100
ip netns add ns2
ip link add ns2-veth-in type veth peer name ns2-veth-out
ip link set ns2-veth-in netns ns2
ip link set ns2-veth-out up
ip netns exec ns2 ip link set lo up
ip netns exec ns2 ifconfig ns2-veth-in 192.168.1.2 netmask 255.255.255.0 up
brctl addif br1 ns2-veth-out
</pre></div>
</details><h3 id="kvm-kvm">kvm - kvm<a class="headerlink" href="#kvm-kvm" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span>tcp: 7.20Gb/s
udp:
    client 8.23Gb/s
    server 3.66Gb/s
</pre></div>

<details class="note"><summary>环境</summary><div class="codehilite"><pre><span></span>Host1:
ip link set em1 mtu 1550
brctl addbr br1
ip link set br1 up
ip link add vtep-100 mtu 1500 type vxlan id 100 group 239.0.0.100 ttl 64 dev em1 dstport 4789
ip link set vtep-100 up
brctl addif br1 vtep-100

Host2:
ip link set em1 mtu 1550
brctl addbr br1
ip link set br1 up
ip link add vtep-100 mtu 1500 type vxlan id 100 group 239.0.0.100 ttl 64 dev em1 dstport 4789
ip link set vtep-100 up
brctl addif br1 vtep-100
</pre></div>
</details><h2 id="ovs"><strong>ovs</strong><a class="headerlink" href="#ovs" title="Permanent link">&para;</a></h2>
<hr />
<p>em1 - - - vtep - ovsbr</p>
<h3 id="keyvni">key指定vni<a class="headerlink" href="#keyvni" title="Permanent link">&para;</a></h3>
<p>由ovs来做vxlan的封装和解封装</p>
<h4 id="ns-nsveth_1">ns - ns（veth）<a class="headerlink" href="#ns-nsveth_1" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span>tcp: 4.23Gb/s
udp:
    client 4.55Gb/s
    server 4.30Gb/s
</pre></div>

<details class="note"><summary>环境</summary><div class="codehilite"><pre><span></span>Host1:
ip link set em1 mtu 1550
ovs-vsctl add-br ovsbr
ovs-vsctl add-port ovsbr vtepHost2 -- set interface vtepHost2 type=vxlan options:remote_ip=10.246.247.90 options:ttl=64 options:key=100
ip netns add ns1
ip link add ns1-veth-in type veth peer name ns1-veth-out
ip link set ns1-veth-in netns ns1
ip link set ns1-veth-out up
ip netns exec ns1 ip link set lo up
ip netns exec ns1 ifconfig ns1-veth-in 192.168.1.1 netmask 255.255.255.0 up
ovs-vsctl add-port ovsbr ns1-veth-out

Host2:
ip link set em1 mtu 1550
ovs-vsctl add-br ovsbr
ovs-vsctl add-port ovsbr vtepHost1 -- set interface vtepHost1 type=vxlan options:remote_ip=10.246.247.89 options:ttl=64 options:key=100
ip netns add ns2
ip link add ns2-veth-in type veth peer name ns2-veth-out
ip link set ns2-veth-in netns ns2
ip link set ns2-veth-out up
ip netns exec ns2 ip link set lo up
ip netns exec ns2 ifconfig ns2-veth-in 192.168.1.2 netmask 255.255.255.0 up
ovs-vsctl add-port ovsbr ns2-veth-out
</pre></div>
</details><h4 id="ns-nsovs-port">ns - ns（ovs-port）<a class="headerlink" href="#ns-nsovs-port" title="Permanent link">&para;</a></h4>
<p>ovs-port(internal)</p>
<div class="codehilite"><pre><span></span>tcp: 4.65Gb/s
udp:
    client 4.80Gb/s
    server 4.50Gb/s
</pre></div>

<details class="note"><summary>环境</summary><div class="codehilite"><pre><span></span>Host1:
ip link set em1 mtu 1550
ovs-vsctl add-br ovsbr
ovs-vsctl add-port ovsbr vtepHost2 -- set interface vtepHost2 type=vxlan options:remote_ip=10.246.247.90 options:ttl=64 options:key=100
ovs-vsctl add-port ovsbr ns1 -- set interface ns1 type=internal
ip netns add ns1
ip link set ns1 netns ns1
ip netns exec ns1 ip link set lo up
ip netns exec ns1 ifconfig ns1 192.168.1.1 netmask 255.255.255.0 up

Host2:
ip link set em1 mtu 1550
ovs-vsctl add-br ovsbr
ovs-vsctl add-port ovsbr vtepHost1 -- set interface vtepHost1 type=vxlan options:remote_ip=10.246.247.89 options:ttl=64 options:key=100
ovs-vsctl add-port ovsbr ns2 -- set interface ns2 type=internal
ip netns add ns2
ip link set ns2 netns ns2
ip netns exec ns2 ip link set lo up
ip netns exec ns2 ifconfig ns2 192.168.1.2 netmask 255.255.255.0 up
</pre></div>
</details><h4 id="kvm-kvm_1">kvm - kvm<a class="headerlink" href="#kvm-kvm_1" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span>tcp: 8.51Gb/s
udp:
    client 5.82Gb/s
    server 4.31Gb/s
</pre></div>

<details class="note"><summary>环境</summary><div class="codehilite"><pre><span></span>Host1:
ip link set em1 mtu 1550
ovs-vsctl add-br ovsbr
ovs-vsctl add-port ovsbr vtepHost2 -- set interface vtepHost2 type=vxlan options:remote_ip=10.246.247.90 options:ttl=64 options:key=100

Host2:
ip link set em1 mtu 1550
ovs-vsctl add-br ovsbr
ovs-vsctl add-port ovsbr vtepHost1 -- set interface vtepHost1 type=vxlan options:remote_ip=10.246.247.89 options:ttl=64 options:key=100
</pre></div>
</details><h3 id="keyflow">key为flow<a class="headerlink" href="#keyflow" title="Permanent link">&para;</a></h3>
<p>自己写openflow来做vxlan的封装和解封装</p>
<h4 id="ns-nsveth_2">ns - ns（veth）<a class="headerlink" href="#ns-nsveth_2" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span>tcp: 4.43Gb/s
udp:
    client 4.75Gb/s
    server 4.42Gb/s
</pre></div>

<details class="note"><summary>环境</summary><div class="codehilite"><pre><span></span>Host1:
# 设置em1的mtu
ip link set em1 mtu 1550

# 创建ovs桥接
ovs-vsctl add-br ovsbr

# 清空流表
ovs-ofctl del-flows ovsbr

# 创建vtep
ovs-vsctl add-port ovsbr vtepHost2 -- set interface vtepHost2 type=vxlan options:remote_ip=10.246.247.90 options:ttl=64 options:in_key=flow options:out_key=flow

# ns
ip netns add ns1
ip link add ns1-veth-in type veth peer name ns1-veth-out
ip link set ns1-veth-in netns ns1
ip link set ns1-veth-out up
ip netns exec ns1 ip link set lo up
ip netns exec ns1 ifconfig ns1-veth-in 192.168.1.1 netmask 255.255.255.0 up
ovs-vsctl add-port ovsbr ns1-veth-out

# openflow
## 获得openflow端口
ns_ofport=`ovs-vsctl get interface ns1-veth-out ofport`
vtepHost2_ofport=`ovs-vsctl get interface vtepHost2 ofport`

## table 0
### 从ns过来的数据包，扔给table 2处理
ovs-ofctl add-flow ovsbr &quot;table=0, priority=1, in_port=${ns_ofport}, actions=goto_table:2&quot;

### 从vtep过来的数据包，扔给table 10处理
ovs-ofctl add-flow ovsbr &quot;table=0, priority=1, in_port=${vtepHost2_ofport}, actions=goto_table:10&quot;

### 其余DROP
ovs-ofctl add-flow ovsbr &quot;table=0, priority=0, actions=drop&quot;

## table 2
## 单播包，扔给table 20处理
ovs-ofctl add-flow ovsbr &quot;table=2, priority=1, dl_dst=00:00:00:00:00:00/01:00:00:00:00:00, actions=goto_table:20&quot;

## 多播包和广播包，扔给table 22处理
ovs-ofctl add-flow ovsbr &quot;table=2, priority=1, dl_dst=01:00:00:00:00:00/01:00:00:00:00:00, actions=goto_table:22&quot;

### 其余DROP
ovs-ofctl add-flow ovsbr &quot;table=2, priority=0, actions=drop&quot;

## table 10
### 学习从vtep过来的数据包，往table 20中添加返程规则，然后输出到ns端口
### 具体学习内容:
###  1. 包的目的mac跟当前的源mac匹配
###  2. 将tunnel号修改为当前的tunnel号
###  3. 从当前入口发出
ovs-ofctl add-flow ovsbr &quot;table=10, priority=1, tun_id=100, actions=learn(table=20,hard_timeout=300,priority=1,NXM_OF_ETH_DST[]=NXM_OF_ETH_SRC[],load:NXM_NX_TUN_ID[]-&gt;NXM_NX_TUN_ID[],output:NXM_OF_IN_PORT[]),output:${ns_ofport}&quot;

### 其余DROP（可选）
ovs-ofctl add-flow ovsbr &quot;table=10, priority=0, actions=drop&quot;

## table 20
### 有学习到规则的数据包，根据规则打上tunnel号并从对应的vtep port发出（动态，不用写规则）

### 其余扔给table 22处理
ovs-ofctl add-flow ovsbr &quot;table=20, priority=0, actions=goto_table:22&quot;

## table 22
### 匹配in_port后打上tunnel号，并从对应的vtep port发出（多条）
ovs-ofctl add-flow ovsbr &quot;table=22, priority=1, in_port=${ns_ofport}, actions=set_tunnel:100,output:${vtepHost2_ofport}&quot;

### 其余DROP
ovs-ofctl add-flow ovsbr &quot;table=22, priority=0, actions=drop&quot;


Host2:
# 设置em1的mtu
ip link set em1 mtu 1550

# 创建ovs桥接
ovs-vsctl add-br ovsbr

# 清空流表
ovs-ofctl del-flows ovsbr

# 创建vtep
ovs-vsctl add-port ovsbr vtepHost1 -- set interface vtepHost1 type=vxlan options:remote_ip=10.246.247.89 options:ttl=64 options:in_key=flow options:out_key=flow

# ns
ip netns add ns2
ip link add ns2-veth-in type veth peer name ns2-veth-out
ip link set ns2-veth-in netns ns2
ip link set ns2-veth-out up
ip netns exec ns2 ip link set lo up
ip netns exec ns2 ifconfig ns2-veth-in 192.168.1.2 netmask 255.255.255.0 up
ovs-vsctl add-port ovsbr ns2-veth-out

# openflow
## 获得openflow端口
ns_ofport=`ovs-vsctl get interface ns2-veth-out ofport`
vtepHost1_ofport=`ovs-vsctl get interface vtepHost1 ofport`

## table 0
### 从ns过来的数据包，扔给table 2处理
ovs-ofctl add-flow ovsbr &quot;table=0, priority=1, in_port=${ns_ofport}, actions=goto_table:2&quot;

### 从vtep过来的数据包，扔给table 10处理
ovs-ofctl add-flow ovsbr &quot;table=0, priority=1, in_port=${vtepHost1_ofport}, actions=goto_table:10&quot;

### 其余DROP
ovs-ofctl add-flow ovsbr &quot;table=0, priority=0, actions=drop&quot;

## table 2
## 单播包，扔给table 20处理
ovs-ofctl add-flow ovsbr &quot;table=2, priority=1, dl_dst=00:00:00:00:00:00/01:00:00:00:00:00, actions=goto_table:20&quot;

## 多播包和广播包，扔给table 22处理
ovs-ofctl add-flow ovsbr &quot;table=2, priority=1, dl_dst=01:00:00:00:00:00/01:00:00:00:00:00, actions=goto_table:22&quot;

### 其余DROP
ovs-ofctl add-flow ovsbr &quot;table=2, priority=0, actions=drop&quot;

## table 10
### 学习从vtep过来的数据包，往table 20中添加返程规则，然后输出到ns端口
### 具体学习内容:
###  1. 包的目的mac跟当前的源mac匹配
###  2. 将tunnel号修改为当前的tunnel号
###  3. 从当前入口发出
ovs-ofctl add-flow ovsbr &quot;table=10, priority=1, tun_id=100, actions=learn(table=20,hard_timeout=300,priority=1,NXM_OF_ETH_DST[]=NXM_OF_ETH_SRC[],load:NXM_NX_TUN_ID[]-&gt;NXM_NX_TUN_ID[],output:NXM_OF_IN_PORT[]),output:${ns_ofport}&quot;

### 其余DROP（可选）
ovs-ofctl add-flow ovsbr &quot;table=10, priority=0, actions=drop&quot;

## table 20
### 有学习到规则的数据包，根据规则打上tunnel号并从对应的vtep port发出（动态，不用写规则）

### 其余扔给table 22处理
ovs-ofctl add-flow ovsbr &quot;table=20, priority=0, actions=goto_table:22&quot;

## table 22
### 匹配in_port后打上tunnel号，并从对应的vtep port发出（多条）
ovs-ofctl add-flow ovsbr &quot;table=22, priority=1, in_port=${ns_ofport}, actions=set_tunnel:100,output:${vtepHost1_ofport}&quot;

### 其余DROP
ovs-ofctl add-flow ovsbr &quot;table=22, priority=0, actions=drop&quot;
</pre></div>
</details><h4 id="ns-nsovs-port_1">ns - ns（ovs-port）<a class="headerlink" href="#ns-nsovs-port_1" title="Permanent link">&para;</a></h4>
<p>ovs-port(internal)</p>
<div class="codehilite"><pre><span></span>tcp: 4.28Gb/s
udp:
    client 5.41Gb/s
    server 4.92Gb/s
</pre></div>

<details class="note"><summary>环境</summary><div class="codehilite"><pre><span></span>Host1:
# 设置em1的mtu
ip link set em1 mtu 1550

# 创建ovs桥接
ovs-vsctl add-br ovsbr

# 清空流表
ovs-ofctl del-flows ovsbr

# 创建vtep
ovs-vsctl add-port ovsbr vtepHost2 -- set interface vtepHost2 type=vxlan options:remote_ip=10.246.247.90 options:ttl=64 options:in_key=flow options:out_key=flow

# ns到ovsbr的patch-port
ovs-vsctl add-port ovsbr ns1 -- set interface ns1 type=internal
ip link set ns1 up
ip netns add ns1
ip link set ns1 netns ns1
ip netns exec ns1 ip link set lo up
ip netns exec ns1 ifconfig ns1 192.168.1.1 netmask 255.255.255.0 up

# openflow
## 获得openflow端口
ns_ofport=`ovs-vsctl get interface ns1 ofport`
vtepHost2_ofport=`ovs-vsctl get interface vtepHost2 ofport`

## table 0
### 从ns过来的数据包，扔给table 2处理
ovs-ofctl add-flow ovsbr &quot;table=0, priority=1, in_port=${ns_ofport}, actions=goto_table:2&quot;

### 从vtep过来的数据包，扔给table 10处理
ovs-ofctl add-flow ovsbr &quot;table=0, priority=1, in_port=${vtepHost2_ofport}, actions=goto_table:10&quot;

### 其余DROP
ovs-ofctl add-flow ovsbr &quot;table=0, priority=0, actions=drop&quot;

## table 2
## 单播包，扔给table 20处理
ovs-ofctl add-flow ovsbr &quot;table=2, priority=1, dl_dst=00:00:00:00:00:00/01:00:00:00:00:00, actions=goto_table:20&quot;

## 多播包和广播包，扔给table 22处理
ovs-ofctl add-flow ovsbr &quot;table=2, priority=1, dl_dst=01:00:00:00:00:00/01:00:00:00:00:00, actions=goto_table:22&quot;

### 其余DROP
ovs-ofctl add-flow ovsbr &quot;table=2, priority=0, actions=drop&quot;

## table 10
### 学习从vtep过来的数据包，往table 20中添加返程规则，然后输出到ns端口
### 具体学习内容:
###  1. 包的目的mac跟当前的源mac匹配
###  2. 将tunnel号修改为当前的tunnel号
###  3. 从当前入口发出
ovs-ofctl add-flow ovsbr &quot;table=10, priority=1, tun_id=100, actions=learn(table=20,hard_timeout=300,priority=1,NXM_OF_ETH_DST[]=NXM_OF_ETH_SRC[],load:NXM_NX_TUN_ID[]-&gt;NXM_NX_TUN_ID[],output:NXM_OF_IN_PORT[]),output:${ns_ofport}&quot;

### 其余DROP（可选）
ovs-ofctl add-flow ovsbr &quot;table=10, priority=0, actions=drop&quot;

## table 20
### 有学习到规则的数据包，根据规则打上tunnel号并从对应的vtep port发出（动态，不用写规则）

### 其余扔给table 22处理
ovs-ofctl add-flow ovsbr &quot;table=20, priority=0, actions=goto_table:22&quot;

## table 22
### 匹配in_port后打上tunnel号，并从对应的vtep port发出（多条）
ovs-ofctl add-flow ovsbr &quot;table=22, priority=1, in_port=${ns_ofport}, actions=set_tunnel:100,output:${vtepHost2_ofport}&quot;

### 其余DROP
ovs-ofctl add-flow ovsbr &quot;table=22, priority=0, actions=drop&quot;


Host2:
# 设置em1的mtu
ip link set em1 mtu 1550

# 创建ovs桥接
ovs-vsctl add-br ovsbr

# 清空流表
ovs-ofctl del-flows ovsbr

# 创建vtep
ovs-vsctl add-port ovsbr vtepHost1 -- set interface vtepHost1 type=vxlan options:remote_ip=10.246.247.89 options:ttl=64 options:in_key=flow options:out_key=flow

# ns到ovsbr的patch-port
ovs-vsctl add-port ovsbr ns2 -- set interface ns2 type=internal
ip link set ns2 up
ip netns add ns2
ip link set ns2 netns ns2
ip netns exec ns2 ip link set lo up
ip netns exec ns2 ifconfig ns2 192.168.1.2 netmask 255.255.255.0 up

# openflow
## 获得openflow端口
ns_ofport=`ovs-vsctl get interface ns2 ofport`
vtepHost1_ofport=`ovs-vsctl get interface vtepHost1 ofport`

## table 0
### 从ns过来的数据包，扔给table 2处理
ovs-ofctl add-flow ovsbr &quot;table=0, priority=1, in_port=${ns_ofport}, actions=goto_table:2&quot;

### 从vtep过来的数据包，扔给table 10处理
ovs-ofctl add-flow ovsbr &quot;table=0, priority=1, in_port=${vtepHost1_ofport}, actions=goto_table:10&quot;

### 其余DROP
ovs-ofctl add-flow ovsbr &quot;table=0, priority=0, actions=drop&quot;

## table 2
## 单播包，扔给table 20处理
ovs-ofctl add-flow ovsbr &quot;table=2, priority=1, dl_dst=00:00:00:00:00:00/01:00:00:00:00:00, actions=goto_table:20&quot;

## 多播包和广播包，扔给table 22处理
ovs-ofctl add-flow ovsbr &quot;table=2, priority=1, dl_dst=01:00:00:00:00:00/01:00:00:00:00:00, actions=goto_table:22&quot;

### 其余DROP
ovs-ofctl add-flow ovsbr &quot;table=2, priority=0, actions=drop&quot;

## table 10
### 学习从vtep过来的数据包，往table 20中添加返程规则，然后输出到ns端口
### 具体学习内容:
###  1. 包的目的mac跟当前的源mac匹配
###  2. 将tunnel号修改为当前的tunnel号
###  3. 从当前入口发出
ovs-ofctl add-flow ovsbr &quot;table=10, priority=1, tun_id=100, actions=learn(table=20,hard_timeout=300,priority=1,NXM_OF_ETH_DST[]=NXM_OF_ETH_SRC[],load:NXM_NX_TUN_ID[]-&gt;NXM_NX_TUN_ID[],output:NXM_OF_IN_PORT[]),output:${ns_ofport}&quot;

### 其余DROP（可选）
ovs-ofctl add-flow ovsbr &quot;table=10, priority=0, actions=drop&quot;

## table 20
### 有学习到规则的数据包，根据规则打上tunnel号并从对应的vtep port发出（动态，不用写规则）

### 其余扔给table 22处理
ovs-ofctl add-flow ovsbr &quot;table=20, priority=0, actions=goto_table:22&quot;

## table 22
### 匹配in_port后打上tunnel号，并从对应的vtep port发出（多条）
ovs-ofctl add-flow ovsbr &quot;table=22, priority=1, in_port=${ns_ofport}, actions=set_tunnel:100,output:${vtepHost1_ofport}&quot;

### 其余DROP
ovs-ofctl add-flow ovsbr &quot;table=22, priority=0, actions=drop&quot;
</pre></div>
</details><h4 id="kvm-kvm_2">kvm - kvm<a class="headerlink" href="#kvm-kvm_2" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span>tcp: 8.77Gb/s
udp:
    client 5.43Gb/s
    server 4.52Gb/s
</pre></div>

<details class="note"><summary>环境</summary><div class="codehilite"><pre><span></span>Host1:
# 设置em1的mtu
ip link set em1 mtu 1550

# 创建ovs桥接
ovs-vsctl add-br ovsbr

# 清空流表
ovs-ofctl del-flows ovsbr

# 创建vtep
ovs-vsctl add-port ovsbr vtepHost2 -- set interface vtepHost2 type=vxlan options:remote_ip=10.246.247.90 options:ttl=64 options:in_key=flow options:out_key=flow


Host2:
# 设置em1的mtu
ip link set em1 mtu 1550

# 创建ovs桥接
ovs-vsctl add-br ovsbr

# 清空流表
ovs-ofctl del-flows ovsbr

# 创建vtep
ovs-vsctl add-port ovsbr vtepHost1 -- set interface vtepHost1 type=vxlan options:remote_ip=10.246.247.89 options:ttl=64 options:in_key=flow options:out_key=flow
</pre></div>
<p>启动虚拟机vm1和vm3</p><div class="codehilite"><pre><span></span>Host1:
# openflow
## 获得openflow端口
vm_ofport=`ovs-vsctl get interface vmeth0-vm1 ofport`
vtepHost2_ofport=`ovs-vsctl get interface vtepHost2 ofport`

## table 0
### 从vm过来的数据包，扔给table 2处理
ovs-ofctl add-flow ovsbr &quot;table=0, priority=1, in_port=${vm_ofport}, actions=goto_table:2&quot;

### 从vtep过来的数据包，扔给table 10处理
ovs-ofctl add-flow ovsbr &quot;table=0, priority=1, in_port=${vtepHost2_ofport}, actions=goto_table:10&quot;

### 其余DROP
ovs-ofctl add-flow ovsbr &quot;table=0, priority=0, actions=drop&quot;

## table 2
## 单播包，扔给table 20处理
ovs-ofctl add-flow ovsbr &quot;table=2, priority=1, dl_dst=00:00:00:00:00:00/01:00:00:00:00:00, actions=goto_table:20&quot;

## 多播包和广播包，扔给table 22处理
ovs-ofctl add-flow ovsbr &quot;table=2, priority=1, dl_dst=01:00:00:00:00:00/01:00:00:00:00:00, actions=goto_table:22&quot;

### 其余DROP
ovs-ofctl add-flow ovsbr &quot;table=2, priority=0, actions=drop&quot;

## table 10
### 学习从vtep过来的数据包，往table 20中添加返程规则，然后输出到vm端口
### 具体学习内容:
###  1. 包的目的mac跟当前的源mac匹配
###  2. 将tunnel号修改为当前的tunnel号
###  3. 从当前入口发出
ovs-ofctl add-flow ovsbr &quot;table=10, priority=1, tun_id=100, actions=learn(table=20,hard_timeout=300,priority=1,NXM_OF_ETH_DST[]=NXM_OF_ETH_SRC[],load:NXM_NX_TUN_ID[]-&gt;NXM_NX_TUN_ID[],output:NXM_OF_IN_PORT[]),output:${vm_ofport}&quot;

### 其余DROP（可选）
ovs-ofctl add-flow ovsbr &quot;table=10, priority=0, actions=drop&quot;

## table 20
### 有学习到规则的数据包，根据规则打上tunnel号并从对应的vtep port发出（动态，不用写规则）

### 其余扔给table 22处理
ovs-ofctl add-flow ovsbr &quot;table=20, priority=0, actions=goto_table:22&quot;

## table 22
### 匹配in_port后打上tunnel号，并从对应的vtep port发出（多条）
ovs-ofctl add-flow ovsbr &quot;table=22, priority=1, in_port=${vm_ofport}, actions=set_tunnel:100,output:${vtepHost2_ofport}&quot;

### 其余DROP
ovs-ofctl add-flow ovsbr &quot;table=22, priority=0, actions=drop&quot;


Host2:
# openflow
## 获得openflow端口
vm_ofport=`ovs-vsctl get interface vmeth0-vm3 ofport`
vtepHost1_ofport=`ovs-vsctl get interface vtepHost1 ofport`

## table 0
### 从vm过来的数据包，扔给table 2处理
ovs-ofctl add-flow ovsbr &quot;table=0, priority=1, in_port=${vm_ofport}, actions=goto_table:2&quot;

### 从vtep过来的数据包，扔给table 10处理
ovs-ofctl add-flow ovsbr &quot;table=0, priority=1, in_port=${vtepHost1_ofport}, actions=goto_table:10&quot;

### 其余DROP
ovs-ofctl add-flow ovsbr &quot;table=0, priority=0, actions=drop&quot;

## table 2
## 单播包，扔给table 20处理
ovs-ofctl add-flow ovsbr &quot;table=2, priority=1, dl_dst=00:00:00:00:00:00/01:00:00:00:00:00, actions=goto_table:20&quot;

## 多播包和广播包，扔给table 22处理
ovs-ofctl add-flow ovsbr &quot;table=2, priority=1, dl_dst=01:00:00:00:00:00/01:00:00:00:00:00, actions=goto_table:22&quot;

### 其余DROP
ovs-ofctl add-flow ovsbr &quot;table=2, priority=0, actions=drop&quot;

## table 10
### 学习从vtep过来的数据包，往table 20中添加返程规则，然后输出到vm端口
### 具体学习内容:
###  1. 包的目的mac跟当前的源mac匹配
###  2. 将tunnel号修改为当前的tunnel号
###  3. 从当前入口发出
ovs-ofctl add-flow ovsbr &quot;table=10, priority=1, tun_id=100, actions=learn(table=20,hard_timeout=300,priority=1,NXM_OF_ETH_DST[]=NXM_OF_ETH_SRC[],load:NXM_NX_TUN_ID[]-&gt;NXM_NX_TUN_ID[],output:NXM_OF_IN_PORT[]),output:${vm_ofport}&quot;

### 其余DROP（可选）
ovs-ofctl add-flow ovsbr &quot;table=10, priority=0, actions=drop&quot;

## table 20
### 有学习到规则的数据包，根据规则打上tunnel号并从对应的vtep port发出（动态，不用写规则）

### 其余扔给table 22处理
ovs-ofctl add-flow ovsbr &quot;table=20, priority=0, actions=goto_table:22&quot;

## table 22
### 匹配in_port后打上tunnel号，并从对应的vtep port发出（多条）
ovs-ofctl add-flow ovsbr &quot;table=22, priority=1, in_port=${vm_ofport}, actions=set_tunnel:100,output:${vtepHost1_ofport}&quot;

### 其余DROP
ovs-ofctl add-flow ovsbr &quot;table=22, priority=0, actions=drop&quot;
</pre></div>
</details><h2 id="ovs-bridge"><strong>ovs-bridge</strong><a class="headerlink" href="#ovs-bridge" title="Permanent link">&para;</a></h2>
<hr />
<div class="codehilite"><pre><span></span>em1 - - - vtep - ovsbr - bridge
</pre></div>

<h3 id="keyvni_1">key指定vni<a class="headerlink" href="#keyvni_1" title="Permanent link">&para;</a></h3>
<h4 id="ns-nsveth_3">ns - ns（veth）<a class="headerlink" href="#ns-nsveth_3" title="Permanent link">&para;</a></h4>
<p>ovsbr和bridge之间用veth</p>
<p>不做测试（无意义），因为veth不仅管理麻烦，而且性能不如ovs-port(internal)</p>
<h4 id="ns-nsovs-port_2">ns - ns（ovs-port）<a class="headerlink" href="#ns-nsovs-port_2" title="Permanent link">&para;</a></h4>
<p>ovsbr和bridge之间用ovs-port(internal)</p>
<div class="codehilite"><pre><span></span>tcp: 4.03Gb/s
udp:
    client 4.19Gb/s
    server 3.82Gb/s
</pre></div>

<details class="note"><summary>环境</summary><div class="codehilite"><pre><span></span>Host1:
ip link set em1 mtu 1550
ovs-vsctl add-br ovsbr
ovs-vsctl add-port ovsbr vtepHost2 -- set interface vtepHost2 type=vxlan options:remote_ip=10.246.247.90 options:ttl=64 options:key=100
brctl addbr br1
ip link set br1 up
ovs-vsctl add-port ovsbr patch-br -- set interface patch-br type=internal
ip link set patch-br up
brctl addif br1 patch-br
ip netns add ns1
ip link add ns1-veth-in type veth peer name ns1-veth-out
ip link set ns1-veth-in netns ns1
ip link set ns1-veth-out up
ip netns exec ns1 ip link set lo up
ip netns exec ns1 ifconfig ns1-veth-in 192.168.1.1 netmask 255.255.255.0 up
brctl addif br1 ns1-veth-out

Host2:
ip link set em1 mtu 1550
ovs-vsctl add-br ovsbr
ovs-vsctl add-port ovsbr vtepHost1 -- set interface vtepHost1 type=vxlan options:remote_ip=10.246.247.89 options:ttl=64 options:key=100
brctl addbr br1
ip link set br1 up
ovs-vsctl add-port ovsbr patch-br -- set interface patch-br type=internal
ip link set patch-br up
brctl addif br1 patch-br
ip netns add ns2
ip link add ns2-veth-in type veth peer name ns2-veth-out
ip link set ns2-veth-in netns ns2
ip link set ns2-veth-out up
ip netns exec ns2 ip link set lo up
ip netns exec ns2 ifconfig ns2-veth-in 192.168.1.2 netmask 255.255.255.0 up
brctl addif br1 ns2-veth-out
</pre></div>
</details><h4 id="kvm-kvm_3">kvm - kvm<a class="headerlink" href="#kvm-kvm_3" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span>tcp: 8.44Gb/s
udp:
    client 5.46Gb/s
    server 3.85Gb/s
</pre></div>

<details class="note"><summary>环境</summary><div class="codehilite"><pre><span></span>Host1:
ip link set em1 mtu 1550
ovs-vsctl add-br ovsbr
ovs-vsctl add-port ovsbr vtepHost2 -- set interface vtepHost2 type=vxlan options:remote_ip=10.246.247.90 options:ttl=64 options:key=100
brctl addbr br1
ip link set br1 up
ovs-vsctl add-port ovsbr patch-br -- set interface patch-br type=internal
ip link set patch-br up
brctl addif br1 patch-br

Host2:
ip link set em1 mtu 1550
ovs-vsctl add-br ovsbr
ovs-vsctl add-port ovsbr vtepHost1 -- set interface vtepHost1 type=vxlan options:remote_ip=10.246.247.89 options:ttl=64 options:key=100
brctl addbr br1
ip link set br1 up
ovs-vsctl add-port ovsbr patch-br -- set interface patch-br type=internal
ip link set patch-br up
brctl addif br1 patch-br
</pre></div>
</details><h3 id="keyflow_1">key为flow<a class="headerlink" href="#keyflow_1" title="Permanent link">&para;</a></h3>
<h4 id="ns-nsveth_4">ns - ns（veth）<a class="headerlink" href="#ns-nsveth_4" title="Permanent link">&para;</a></h4>
<p>ovsbr和bridge之间用veth</p>
<p>不做测试（无意义），因为veth不仅管理麻烦，而且性能不如ovs-port(internal)</p>
<h4 id="ns-nsovs-port_3">ns - ns（ovs-port）<a class="headerlink" href="#ns-nsovs-port_3" title="Permanent link">&para;</a></h4>
<p>ovsbr和bridge之间用ovs-port(internal)</p>
<div class="codehilite"><pre><span></span>tcp: 4.25Gb/s
udp:
    client 4.29Gb/s
    server 2.88Gb/s
</pre></div>

<details class="note"><summary>环境</summary><div class="codehilite"><pre><span></span>Host1:
# 设置em1的mtu
ip link set em1 mtu 1550

# 创建ovs桥接
ovs-vsctl add-br ovsbr

# 清空流表
ovs-ofctl del-flows ovsbr

# 创建vtep
ovs-vsctl add-port ovsbr vtepHost2 -- set interface vtepHost2 type=vxlan options:remote_ip=10.246.247.90 options:ttl=64 options:in_key=flow options:out_key=flow

# 创建linux bridge
brctl addbr br1
ip link set br1 up

# linux bridge到ovsbr的patch-port
ovs-vsctl add-port ovsbr patch-br -- set interface patch-br type=internal
ip link set patch-br up
brctl addif br1 patch-br

# openflow
## 获得openflow端口
patch_ofport=`ovs-vsctl get interface patch-br ofport`
vtepHost2_ofport=`ovs-vsctl get interface vtepHost2 ofport`

## table 0
### 从linux-bridge过来的数据包，扔给table 2处理
ovs-ofctl add-flow ovsbr &quot;table=0, priority=1, in_port=${patch_ofport}, actions=goto_table:2&quot;

### 从vtep过来的数据包，扔给table 10处理
ovs-ofctl add-flow ovsbr &quot;table=0, priority=1, in_port=${vtepHost2_ofport}, actions=goto_table:10&quot;

### 其余DROP
ovs-ofctl add-flow ovsbr &quot;table=0, priority=0, actions=drop&quot;

## table 2
## 单播包，扔给table 20处理
ovs-ofctl add-flow ovsbr &quot;table=2, priority=1, dl_dst=00:00:00:00:00:00/01:00:00:00:00:00, actions=goto_table:20&quot;

## 多播包和广播包，扔给table 22处理
ovs-ofctl add-flow ovsbr &quot;table=2, priority=1, dl_dst=01:00:00:00:00:00/01:00:00:00:00:00, actions=goto_table:22&quot;

### 其余DROP
ovs-ofctl add-flow ovsbr &quot;table=2, priority=0, actions=drop&quot;

## table 10
### 学习从vtep过来的数据包，往table 20中添加返程规则，然后输出到linux-bridge端口
### 具体学习内容:
###  1. 包的目的mac跟当前的源mac匹配
###  2. 将tunnel号修改为当前的tunnel号
###  3. 从当前入口发出
ovs-ofctl add-flow ovsbr &quot;table=10, priority=1, tun_id=100, actions=learn(table=20,hard_timeout=300,priority=1,NXM_OF_ETH_DST[]=NXM_OF_ETH_SRC[],load:NXM_NX_TUN_ID[]-&gt;NXM_NX_TUN_ID[],output:NXM_OF_IN_PORT[]),output:${patch_ofport}&quot;

### 其余DROP（可选）
ovs-ofctl add-flow ovsbr &quot;table=10, priority=0, actions=drop&quot;

## table 20
### 有学习到规则的数据包，根据规则打上tunnel号并从对应的vtep port发出（动态，不用写规则）

### 其余扔给table 22处理
ovs-ofctl add-flow ovsbr &quot;table=20, priority=0, actions=goto_table:22&quot;

## table 22
### 匹配in_port后打上tunnel号，并从对应的vtep port发出（多条）
ovs-ofctl add-flow ovsbr &quot;table=22, priority=1, in_port=${patch_ofport}, actions=set_tunnel:100,output:${vtepHost2_ofport}&quot;

### 其余DROP
ovs-ofctl add-flow ovsbr &quot;table=22, priority=0, actions=drop&quot;

# ns
ip netns add ns1
ip link add ns1-veth-in type veth peer name ns1-veth-out
ip link set ns1-veth-in netns ns1
ip link set ns1-veth-out up
ip netns exec ns1 ip link set lo up
ip netns exec ns1 ifconfig ns1-veth-in 192.168.1.1 netmask 255.255.255.0 up
brctl addif br1 ns1-veth-out


Host2:
# 设置em1的mtu
ip link set em1 mtu 1550

# 创建ovs桥接
ovs-vsctl add-br ovsbr

# 清空流表
ovs-ofctl del-flows ovsbr

# 创建vtep
ovs-vsctl add-port ovsbr vtepHost1 -- set interface vtepHost1 type=vxlan options:remote_ip=10.246.247.89 options:ttl=64 options:in_key=flow options:out_key=flow

# 创建linux bridge
brctl addbr br1
ip link set br1 up

# linux bridge到ovsbr的patch-port
ovs-vsctl add-port ovsbr patch-br -- set interface patch-br type=internal
ip link set patch-br up
brctl addif br1 patch-br

# openflow
## 获得openflow端口
patch_ofport=`ovs-vsctl get interface patch-br ofport`
vtepHost1_ofport=`ovs-vsctl get interface vtepHost1 ofport`

## table 0
### 从linux-bridge过来的数据包，扔给table 2处理
ovs-ofctl add-flow ovsbr &quot;table=0, priority=1, in_port=${patch_ofport}, actions=goto_table:2&quot;

### 从vtep过来的数据包，扔给table 10处理
ovs-ofctl add-flow ovsbr &quot;table=0, priority=1, in_port=${vtepHost1_ofport}, actions=goto_table:10&quot;

### 其余DROP
ovs-ofctl add-flow ovsbr &quot;table=0, priority=0, actions=drop&quot;

## table 2
## 单播包，扔给table 20处理
ovs-ofctl add-flow ovsbr &quot;table=2, priority=1, dl_dst=00:00:00:00:00:00/01:00:00:00:00:00, actions=goto_table:20&quot;

## 多播包和广播包，扔给table 22处理
ovs-ofctl add-flow ovsbr &quot;table=2, priority=1, dl_dst=01:00:00:00:00:00/01:00:00:00:00:00, actions=goto_table:22&quot;

### 其余DROP
ovs-ofctl add-flow ovsbr &quot;table=2, priority=0, actions=drop&quot;

## table 10
### 学习从vtep过来的数据包，往table 20中添加返程规则，然后输出到linux-bridge端口
### 具体学习内容:
###  1. 包的目的mac跟当前的源mac匹配
###  2. 将tunnel号修改为当前的tunnel号
###  3. 从当前入口发出
ovs-ofctl add-flow ovsbr &quot;table=10, priority=1, tun_id=100, actions=learn(table=20,hard_timeout=300,priority=1,NXM_OF_ETH_DST[]=NXM_OF_ETH_SRC[],load:NXM_NX_TUN_ID[]-&gt;NXM_NX_TUN_ID[],output:NXM_OF_IN_PORT[]),output:${patch_ofport}&quot;

### 其余DROP（可选）
ovs-ofctl add-flow ovsbr &quot;table=10, priority=0, actions=drop&quot;

## table 20
### 有学习到规则的数据包，根据规则打上tunnel号并从对应的vtep port发出（动态，不用写规则）

### 其余扔给table 22处理
ovs-ofctl add-flow ovsbr &quot;table=20, priority=0, actions=goto_table:22&quot;

## table 22
### 匹配in_port后打上tunnel号，并从对应的vtep port发出（多条）
ovs-ofctl add-flow ovsbr &quot;table=22, priority=1, in_port=${patch_ofport}, actions=set_tunnel:100,output:${vtepHost1_ofport}&quot;

### 其余DROP
ovs-ofctl add-flow ovsbr &quot;table=22, priority=0, actions=drop&quot;

# ns
ip netns add ns2
ip link add ns2-veth-in type veth peer name ns2-veth-out
ip link set ns2-veth-in netns ns2
ip link set ns2-veth-out up
ip netns exec ns2 ip link set lo up
ip netns exec ns2 ifconfig ns2-veth-in 192.168.1.2 netmask 255.255.255.0 up
brctl addif br1 ns2-veth-out
</pre></div>
</details><h4 id="kvm-kvm_4">kvm - kvm<a class="headerlink" href="#kvm-kvm_4" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span>tcp: 6.89Gb/s
udp:
    client 4.72Gb/s
    server 4.55Gb/s
</pre></div>

<details class="note"><summary>环境</summary><p>和上面这个一样，只是不用# ns部分</p></details><h2 id="neutron"><strong>Neutron模式</strong><a class="headerlink" href="#neutron" title="Permanent link">&para;</a></h2>
<hr />
<p>vm -&gt; bridge --veth&rarr; br-int --patch&rarr; br-tun -&gt; vtep，即openstack的性能测试</p>
<h3 id="kvm-kvm_5">kvm - kvm<a class="headerlink" href="#kvm-kvm_5" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span>tcp: 8.52Gb/s
udp:
    client 4.48Gb/s
    server 3.96Gb/s
</pre></div>

<details class="note"><summary>环境</summary><div class="codehilite"><pre><span></span>Host1:
# 设置em1的mtu
ip link set em1 mtu 1550

# bridge
brctl addbr br1
ip link set br1 up

# veth
ip link add veth-b type veth peer name veth-o
ip link set veth-b up
ip link set veth-o up
brctl addif br1 veth-b

# br-int
ovs-vsctl add-br br-int
ovs-vsctl add-port br-int veth-o
ovs-vsctl set port veth-o tag=1

# patch
ovs-vsctl add-port br-int patch-tun -- set interface patch-tun type=patch options:peer=patch-int

# br-tun
ovs-vsctl add-br br-tun
ovs-ofctl del-flows br-tun
ovs-vsctl add-port br-tun patch-int -- set interface patch-int type=patch options:peer=patch-tun

# vtep
ovs-vsctl add-port br-tun vtepHost2 -- set interface vtepHost2 type=vxlan options:remote_ip=10.246.247.90 options:ttl=64 options:in_key=flow options:out_key=flow

# openflow
## 获得openflow端口
patch_ofport=`ovs-vsctl get interface patch-int ofport`
vtepHost2_ofport=`ovs-vsctl get interface vtepHost2 ofport`

## table 0
ovs-ofctl add-flow br-tun &quot;table=0, priority=1, in_port=${patch_ofport}, actions=goto_table:2&quot;
ovs-ofctl add-flow br-tun &quot;table=0, priority=1, in_port=${vtepHost2_ofport}, actions=goto_table:4&quot;

## table 2
ovs-ofctl add-flow br-tun &quot;table=2, priority=0, dl_dst=00:00:00:00:00:00/01:00:00:00:00:00, actions=goto_table:20&quot;
ovs-ofctl add-flow br-tun &quot;table=2, priority=0, dl_dst=01:00:00:00:00:00/01:00:00:00:00:00, actions=goto_table:22&quot;

## table 4
ovs-ofctl add-flow br-tun &quot;table=4, priority=1, tun_id=0x3e9, actions=mod_vlan_vid:1, goto_table:10&quot;
ovs-ofctl add-flow br-tun &quot;table=4, priority=0, actions=drop&quot;

## table 10
ovs-ofctl add-flow br-tun &quot;table=10, priority=1, actions=learn(table=20,hard_timeout=300,priority=1,NXM_OF_VLAN_TCI[0..11],NXM_OF_ETH_DST[]=NXM_OF_ETH_SRC[],load:0-&gt;NXM_OF_VLAN_TCI[],load:NXM_NX_TUN_ID[]-&gt;NXM_NX_TUN_ID[],output:NXM_OF_IN_PORT[]),output:${patch_ofport}&quot;

## table 20
ovs-ofctl add-flow br-tun &quot;table=20, priority=0, actions=goto_table:22&quot;

## table 22
ovs-ofctl add-flow br-tun &quot;table=22, priority=1, dl_vlan=1, actions=strip_vlan,set_tunnel:0x3e9,output:${vtepHost2_ofport}&quot;


Host2:
# 设置em1的mtu
ip link set em1 mtu 1550

# bridge
brctl addbr br1
ip link set br1 up

# veth
ip link add veth-b type veth peer name veth-o
ip link set veth-b up
ip link set veth-o up
brctl addif br1 veth-b

# br-int
ovs-vsctl add-br br-int
ovs-vsctl add-port br-int veth-o
ovs-vsctl set port veth-o tag=1

# patch
ovs-vsctl add-port br-int patch-tun -- set interface patch-tun type=patch options:peer=patch-int

# br-tun
ovs-vsctl add-br br-tun
ovs-ofctl del-flows br-tun
ovs-vsctl add-port br-tun patch-int -- set interface patch-int type=patch options:peer=patch-tun

# vtep
ovs-vsctl add-port br-tun vtepHost1 -- set interface vtepHost1 type=vxlan options:remote_ip=10.246.247.89 options:ttl=64 options:in_key=flow options:out_key=flow

# openflow
## 获得openflow端口
patch_ofport=`ovs-vsctl get interface patch-int ofport`
vtepHost1_ofport=`ovs-vsctl get interface vtepHost1 ofport`

## table 0
ovs-ofctl add-flow br-tun &quot;table=0, priority=1, in_port=${patch_ofport}, actions=goto_table:2&quot;
ovs-ofctl add-flow br-tun &quot;table=0, priority=1, in_port=${vtepHost1_ofport}, actions=goto_table:4&quot;

## table 2
ovs-ofctl add-flow br-tun &quot;table=2, priority=0, dl_dst=00:00:00:00:00:00/01:00:00:00:00:00, actions=goto_table:20&quot;
ovs-ofctl add-flow br-tun &quot;table=2, priority=0, dl_dst=01:00:00:00:00:00/01:00:00:00:00:00, actions=goto_table:22&quot;

## table 4
ovs-ofctl add-flow br-tun &quot;table=4, priority=1, tun_id=0x3e9, actions=mod_vlan_vid:1, goto_table:10&quot;
ovs-ofctl add-flow br-tun &quot;table=4, priority=0, actions=drop&quot;

## table 10
ovs-ofctl add-flow br-tun &quot;table=10, priority=1, actions=learn(table=20,hard_timeout=300,priority=1,NXM_OF_VLAN_TCI[0..11],NXM_OF_ETH_DST[]=NXM_OF_ETH_SRC[],load:0-&gt;NXM_OF_VLAN_TCI[],load:NXM_NX_TUN_ID[]-&gt;NXM_NX_TUN_ID[],output:NXM_OF_IN_PORT[]),output:${patch_ofport}&quot;

## table 20
ovs-ofctl add-flow br-tun &quot;table=20, priority=0, actions=goto_table:22&quot;

## table 22
ovs-ofctl add-flow br-tun &quot;table=22, priority=1, dl_vlan=1, actions=strip_vlan,set_tunnel:0x3e9,output:${vtepHost1_ofport}&quot;
</pre></div>
</details>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../stress_two_novxlan/" title="2.3. 不同宿主(无封装)" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                2.3. 不同宿主(无封装)
              </span>
            </div>
          </a>
        
        
          <a href="../stress_summary/" title="2.5. 结论" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                2.5. 结论
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
      <a href="https://github.com/cyent" class="md-footer-social__link fa fa-github"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application-f3ab9e5ff8.js"></script>
      
      
      <script>app.initialize({url:{base:"../.."}})</script>
      
        <script src="../../js/extra.js"></script>
      
        <script src="../../js/baidu-tongji.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
    
      
    
  </body>
</html>